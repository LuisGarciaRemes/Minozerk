<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 7</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

    var config = {
        type: Phaser.AUTO,
        width: 800,
        height: 600,update: update,
        physics: {
            default: 'arcade',
            arcade: {
                gravity: { y: 0},
                debug: false
            }
        },
        scene: {
            preload: preload,
            create: create,
            update: update
        }
    };

    var player;
    var playerPrevX;
    var playerPrevY;
    var enemies;
    var enemySpeed;
    var boarderWalls;
    var cursors;
    var button;
    var lasers;
    var enemyLasers;
    var scoreText;
    var score;
    var laserSpeed;
    var playerSpeed;
    var isShooting;
    var shootingTimer;
    var shootingDelay;
    var canShoot;
    var facingRight;
    var levelOneWalls;
    var levelTwoWalls;
    var nextRoomColliders;
    var detectionOffset;
    var currentRoom;
    var nextRoom;
    var firstRoom;
    var lives;
    var otto;
    var ottoTimer;
    var time;
    var entryX;
    var entryY;
    var doors;

    var game = new Phaser.Game(config);

    function preload ()
    {
        this.load.image('sky', 'assets/sky.png');
        this.load.image('horizontalwall', 'assets/horizontalwall.png');
        this.load.image('verticalwall', 'assets/verticalwall.png');
        this.load.image('horizontalCollider', 'assets/horizontalCollider.png');
        this.load.image('verticalCollider', 'assets/verticalCollider.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('laser', 'assets/bomb.png');
        this.load.image('otto', 'assets/placeholder_otto.png');
        this.load.spritesheet('duderight', 'assets/placeholder_runcycle-Sheet.png', { frameWidth: 32, frameHeight: 64 });
        this.load.spritesheet('dudeleft', 'assets/placeholder_runcycle-Sheetleft.png', { frameWidth: 32, frameHeight: 64 });
        this.load.spritesheet('idleright', 'assets/placeholder_basesprite.png', { frameWidth: 32, frameHeight: 64 });
        this.load.spritesheet('idleleft', 'assets/placeholder_basespriteleft.png', { frameWidth: 32, frameHeight: 64 });
        this.load.spritesheet('enemyleft', 'assets/placeholder_enemy_runcycle-Sheetleft.png', { frameWidth: 32, frameHeight: 64 });
        this.load.spritesheet('enemyright', 'assets/placeholder_enemy_runcycle-Sheet.png', { frameWidth: 32, frameHeight: 64 });
        laserSpeed = 300;
        playerSpeed = 150;
        enemySpeed = 1;
        isShooting = false;
        canShoot = true;
        shootingTimer = 0;
        shootingDelay = 1000; // 1000 = 1 second
        facingRight = true;
        score = 0;
        playerPrevX = 0;
        playerPrevY = 0;
        detectionOffset = 15;
        firstRoom = true;
    }

    function create ()
    {
        this.add.image(400, 300, 'sky');
        nextRoomColliders = this.physics.add.staticGroup();
        doors = this.physics.add.staticGroup();
        boarderWalls = this.physics.add.staticGroup();
        levelOneWalls = this.physics.add.staticGroup();
        levelTwoWalls = this.physics.add.staticGroup();
        lives = this.add.group();
        otto = this.physics.add.sprite(500, 450, 'otto');

        resetOtto();

        enemies = this.physics.add.group();
        enemies.createMultiple({
    key: 'enemyright',visible:true,active:true,
    repeat: 4,
    setXY: { x: 200, y: 100,stepX: 70, stepY: 50}
        });

        createNextRoomColliders();
        createBoarder(); // creats the wall for the game boarder.
        createLevelOne();
        createLevelTwo();
        toggleLevelOff(levelTwoWalls);
        currentRoom = levelOneWalls;
        nextRoom = levelTwoWalls;

        lasers = this.physics.add.group();
        lasers.createMultiple({
    key: 'laser',visible:false,active:false,
    repeat: 15,
    setXY: { x: 0, y: 580}
          });

          lives.createMultiple({
      key: 'duderight',visible:true,active:true,
      repeat: 2,
      setXY: { x: 200, y: 565 , stepX: 40}
            });

          var i = 0;
          enemyLasers = this.physics.add.group();
          enemyLasers.createMultiple({
      key: 'laser',visible:false,active:false,
      repeat: 15,
      setXY: { x: 0, y: 580}
            });
              enemies.children.iterate(function (enemy) {
                enemy.child = enemyLasers.getFirstNth(i);
                enemy.child.disableBody();
                i++;
              });
        player = this.physics.add.sprite(100, 450, 'duderight');
        player.setCollideWorldBounds(true);
        createAnimations(this.anims);// creates the animations. passes in the animator from the game

        cursors = this.input.keyboard.createCursorKeys();
        button = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
        this.physics.add.overlap(nextRoomColliders, player, loadNextRoom, null, this);
        this.physics.add.overlap(enemies, lasers, destroyBothPoints, null, this);
        this.physics.add.overlap(enemyLasers, lasers, destroyBothNoPoints, null, this);
        this.physics.add.overlap(enemyLasers, player, destroyBothNoPoints, null, this);
        this.physics.add.overlap(enemyLasers,enemies , destroyOtherNoPoints, null, this); // lasers destroyed by enemy collision
        this.physics.add.overlap(enemies, player, destroyBothPoints, null, this);
        this.physics.add.overlap(lasers, boarderWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(lasers, levelOneWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(enemyLasers, levelOneWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(enemyLasers, boarderWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(enemyLasers, nextRoomColliders, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(player, boarderWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(player, levelOneWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(player, otto, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(enemies, otto, destroyOtherPoints, null, this);
        this.physics.add.overlap(player,doors,destroyOtherNoPoints,null,this);
        this.physics.add.overlap(lasers, levelTwoWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(enemyLasers, levelTwoWalls, destroyOtherNoPoints, null, this);
        this.physics.add.overlap(player, levelTwoWalls, destroyOtherNoPoints, null, this);

        entryX = player.x;
        entryY = player.y;

        scoreText = this.add.text(400, 550, 'score: 0', { fontSize: '32px', fill: '#000' });
    }

    function removeLife()
    {
      var life = lives.getFirstAlive();
      life.setActive(false);
      life.setVisible(false);
    }
    function enemyMovement(enemy)
    {
        var distanceX = Math.abs(enemy.x - player.x);
        var distanceY = Math.abs(enemy.y - player.y);

        var speed = enemySpeed;

        if(enemy == otto)
        {
          speed = enemySpeed*2;
        }

        if((distanceX > distanceY - detectionOffset  && distanceX < distanceY + detectionOffset) || (distanceY > distanceX - detectionOffset  && distanceY < distanceX + detectionOffset))
          {
            if((player.y > enemy.y) && (player.x < enemy.x))
            {
            enemy.y += speed;
            enemy.x += -speed;
            }
            else if ((player.y < enemy.y) && (player.x < enemy.x))
            {
              enemy.y += -speed;
              enemy.x += -speed;
            }
            else if((player.x > enemy.x)&& (player.y > enemy.y))
            {
              enemy.y += speed;
              enemy.x += speed;
            }
            else if((player.x > enemy.x)&&(player.y < enemy.y))
             {
              enemy.x += speed;
              enemy.y += -speed;
            }
        }
        else{
          if((distanceX < distanceY && distanceX != 0) || (distanceX > distanceY  && (distanceY <= 1 && distanceY>=0)))
          {
            if(player.x < enemy.x)
            {
              enemy.x += -speed;
            }
            else if(player.x > enemy.x) {
              enemy.x += speed;
            }
          }
          else if((distanceY < distanceX  && distanceY != 0) || (distanceY > distanceX  && (distanceX <= 1 && distanceX>=0)))
          {
            if(player.y > enemy.y)
            {
            enemy.y += speed;
            }
            else if (player.y < enemy.y)
            {
              enemy.y += -speed;
            }
          }
        }
    }
    function enemyShoot()
    {
      enemies.children.iterate(function (enemy) {
        var distanceX = Math.abs(enemy.x - player.x);
        var distanceY = Math.abs(enemy.y - player.y);

        if(!enemy.child.active && ((distanceX > distanceY - detectionOffset  && distanceX < distanceY + detectionOffset) || (distanceY > distanceX - detectionOffset  && distanceY < distanceX + detectionOffset)) && enemy.active){
          enemy.child.setActive(true);
          enemy.child.setVisible(true);
          enemy.child.enableBody();
          enemy.child.x = enemy.x;
          enemy.child.y = enemy.y;

          if((player.y > enemy.y) && (player.x < enemy.x))
          {
            enemy.child.setVelocityY(laserSpeed/2);
            enemy.child.setVelocityX(-laserSpeed/2);
            //enemy.child.rotation = -.785;
          }
          else if ((player.y < enemy.y) && (player.x < enemy.x))
          {
            enemy.child.setVelocityY(-laserSpeed/2);
            enemy.child.setVelocityX(-laserSpeed/2);
            //enemy.child.rotation = -2.356;
          }
          else if((player.x > enemy.x)&& (player.y > enemy.y))
          {
            enemy.child.setVelocityY(laserSpeed/2);
            enemy.child.setVelocityX(laserSpeed/2);
          //  enemy.child.rotation = .785;
          }
          else if((player.x > enemy.x)&&(player.y < enemy.y))
           {
             enemy.child.setVelocityY(-laserSpeed/2);
             enemy.child.setVelocityX(laserSpeed/2);
            // enemy.child.rotation = 2.356;
          }

        }
         else if(!enemy.child.active && ((enemy.x >= player.x - detectionOffset && enemy.x <= player.x + detectionOffset) || (enemy.y >= player.y - detectionOffset && enemy.y <= player.y + detectionOffset)) && enemy.active)
        {
          enemy.child.setActive(true);
          enemy.child.setVisible(true);
          enemy.child.enableBody();
          enemy.child.x = enemy.x;
          enemy.child.y = enemy.y;

          if((enemy.y >= player.y - detectionOffset && enemy.y <= player.y + detectionOffset) && (player.x < enemy.x))
          {
            enemy.child.setVelocityX(-laserSpeed);
            enemy.child.setVelocityY(0);
            //enemy.child.rotation = 0;
          }
          else if((enemy.y >= player.y - detectionOffset && enemy.y <= player.y + detectionOffset) && (player.x > enemy.x))
          {
            enemy.child.setVelocityX(laserSpeed);
            enemy.child.setVelocityY(0);
            //enemy.child.rotation = 0;
          }
          else if((enemy.x >= player.x - detectionOffset && enemy.x <= player.x + detectionOffset) && (player.y < enemy.y))
          {
            enemy.child.setVelocityX(0);
            enemy.child.setVelocityY(-laserSpeed);
            //enemy.child.rotation = 1.57;
          }
          else if((enemy.x >= player.x - detectionOffset && enemy.x <= player.x + detectionOffset) && (player.y > enemy.y))
          {
            enemy.child.setVelocityX(0);
            enemy.child.setVelocityY(laserSpeed);
          //  enemy.child.rotation = 1.57;
          }
        }
      });
    }
    function update (time, delta)
    {
      controls(time);
      if(player.active)
      {
        enemies.children.iterate(function (enemy) {enemyMovement(enemy)});
        enemyMovement(otto);

        if(!firstRoom)
        {
        enemyShoot();
         }
      }
        //Makes the player unable to move while shooting
        if(isShooting)
        {
          player.setVelocityY(0);
          player.setVelocityX(0);
        }

        // Timer for shooting
        if(time >= shootingTimer + shootingDelay)
        {
          canShoot = true;
        }

        callOtto(time);
    }
    function controls(time)
    {
      this.time = time;
      if (cursors.left.isDown&& player.active)
      {
          player.setVelocityX(-playerSpeed);
          player.anims.play('left', true);
          facingRight = false;
      }

      if (cursors.right.isDown&& player.active)
      {
          player.setVelocityX(playerSpeed);
          player.anims.play('right', true);
          facingRight = true;
      }

      if (cursors.up.isDown&& player.active)
      {
          player.setVelocityY(-playerSpeed);

          if(facingRight)
          {
            player.anims.play('right', true);
          }
          else {
            {
              player.anims.play('left', true);
            }
          }
      }

      if (cursors.down.isDown&& player.active)
      {
          player.setVelocityY(playerSpeed);

          if(facingRight)
          {
            player.anims.play('right', true);
          }
          else {
            {
              player.anims.play('left', true);
            }
          }
      }


      if (cursors.down.isUp && cursors.up.isUp && cursors.left.isUp && cursors.right.isUp&& player.active)
      {
        if(facingRight)
        {
          player.anims.play('idleright', true);
        }
        else
        {
            player.anims.play('idleleft', true);
        }
      }

      if (cursors.down.isUp && cursors.up.isUp)
      {
          player.setVelocityY(0);
      }

      if(cursors.left.isUp && cursors.right.isUp)
      {
        player.setVelocityX(0);
      }

      if (button.isDown && (cursors.down.isDown || cursors.up.isDown || cursors.left.isDown||cursors.right.isDown) && canShoot && player.active)
      {
        fireLaser(time,player);
      }

      if (button.isDown && !player.active && lives.countActive(true) != 0)
      {
        player.x = entryX;
        player.y = entryY;
        player.setActive(true);
        player.setVisible(true);
        player.enableBody();
      }

      if (button.isUp)
      {
        isShooting = false;
      }
    }
    function fireLaser(time , parent)
    {

      var laser = lasers.getFirstDead();
        laser.enableBody();
        laser.setVisible(true);
        laser.setActive(true);
        parent.child = laser;
        isShooting = true;
        canShoot = false;
        shootingTimer = time;

        if (cursors.down.isDown && cursors.right.isDown)
        {
          laser.setVelocityY(laserSpeed);
          laser.setVelocityX(laserSpeed);
          //laser.rotation = .785;
        }
        else if (cursors.down.isDown && cursors.left.isDown)
        {
          laser.setVelocityY(laserSpeed);
          laser.setVelocityX(-laserSpeed);
          //laser.rotation = -.785;
        }
        else if (cursors.up.isDown && cursors.right.isDown)
        {
          laser.setVelocityY(-laserSpeed);
          laser.setVelocityX(laserSpeed);
          //laser.rotation = 2.356;
        }
        else if (cursors.up.isDown && cursors.left.isDown)
        {
          laser.setVelocityY(-laserSpeed);
          laser.setVelocityX(-laserSpeed);
          //laser.rotation = -2.356;
        }
        else if (cursors.left.isDown)
        {
            laser.setVelocityX(-laserSpeed);
            laser.setVelocityY(0);
            //laser.rotation = 0;
        }
        else if (cursors.right.isDown)
        {
            laser.setVelocityX(laserSpeed);
            laser.setVelocityY(0);
          //  laser.rotation = 0;
        }
        else if (cursors.up.isDown)
        {
          //laser.rotation = 1.57;
          laser.setVelocityX(0);
          laser.setVelocityY(-laserSpeed);
        }
        else if (cursors.down.isDown)
        {
          //laser.rotation = 1.57;
          laser.setVelocityX(0);
          laser.setVelocityY(laserSpeed);
        }

        laser.setX(parent.x);
        laser.setY(parent.y);
    }
    function destroyOtherNoPoints(other, object)
    {
       if(object.child != other)
      {
          other.disableBody(true,true);
          other.setActive(false);

          if(other == player)
          {
            removeLife();
          }

      }
    }
    function destroyOtherPoints(object,other)
    {
          other.disableBody(true,true);
          other.setActive(false);
          score += 50;
          scoreText.setText('Score: ' + score);
    }
    function destroyBothPoints(object1, object2)
    {
      if(object1.child != object2)
      {
      object1.disableBody(true,true);
      object1.setActive(false);
      object2.disableBody(true,true);
      object2.setActive(false);
      score += 50;
      scoreText.setText('Score: ' + score);

      if(object1 == player || object2 == player)
      {
        removeLife();
      }

      }
    }
    function destroyBothNoPoints(object1, object2)
    {
      object1.disableBody(true,true);
      object2.disableBody(true,true);
      object1.setActive(false);
      object2.setActive(false);

      if(object1 == player || object2 == player)
      {
        removeLife();
      }
    }
    function createBoarder()
    {
      boarderWalls.create(15, 110, 'verticalwall'); // top left corner
      boarderWalls.create(110, 15, 'horizontalwall');//topleft corner
      boarderWalls.create(230, 15, 'horizontalwall');//topleft corner
        boarderWalls.create(680, 15, 'horizontalwall');//top right corner
        boarderWalls.create(775, 110, 'verticalwall');// top right corner
        boarderWalls.create(560, 15, 'horizontalwall');//topright corner
      boarderWalls.create(680, 525, 'horizontalwall');//bottom right corner
        boarderWalls.create(560, 525, 'horizontalwall');//bottom right corner
        boarderWalls.create(775, 425, 'verticalwall');// bottom right corner
        boarderWalls.create(110, 525, 'horizontalwall');//bottom left corner
      boarderWalls.create(230, 525, 'horizontalwall');//bottomleft corner
        boarderWalls.create(15, 425, 'verticalwall');// bottom left corner
    }
    function createNextRoomColliders()
    {
      nextRoomColliders.create(10,265,'verticalCollider'); //leftExit 0
      nextRoomColliders.create(395,10, 'horizontalCollider');//topExit 1
      nextRoomColliders.create(780,265,'verticalCollider');//rightExit 2
      nextRoomColliders.create(395,530,'horizontalCollider');//bottomExit 3

      doors.create(20,265,'verticalCollider'); //leftExit 0
      doors.create(395,20, 'horizontalCollider');//topExit 1
      doors.create(770,265,'verticalCollider');//rightExit 2
      doors.create(395,520,'horizontalCollider');//bottomExit 3

      var i =0;
      nextRoomColliders.children.iterate(function (exit) {
        exit.child = i;
        i++;
      });

      i =0;
      doors.children.iterate(function (exit) {
        exit.child = i;
        exit.setActive(false);
        exit.disableBody();
        exit.setVisible(false);
        i++
      });

      nextRoomColliders.toggleVisible();
    }
    function toggleLevelOff(level)
    {
      level.children.iterate(function (levelWall) {
         levelWall.disableBody();
         levelWall.setActive(false);
         levelWall.setVisible(false);
       });
    }
    function toggleLevelOn(level)
    {
      level.children.iterate(function (levelWall) {
         levelWall.enableBody(true,true);
         levelWall.setActive(true);
         levelWall.setVisible(true);
       });
    }
    function loadNextRoom(player,collider)
    {
      if(collider.child == 0)
      {
        player.x = 740;
        closeDoor(2);
      }
      else if(collider.child == 1)
      {
        player.y = 480;
        closeDoor(3);
      }
      else if(collider.child == 2)
      {
        player.x = 50;
        closeDoor(0);
      }
      else if (collider.child == 3)
        {
          player.y = 70;
          closeDoor(1);
        }

        entryX = player.x;
        entryY = player.y;
        firstRoom = false;
        resetOtto();

        if(enemies.countActive() == 0)
        {
        score += 100;
        scoreText.setText('Score: ' + score);
        }
      toggleLevelOn(nextRoom);
      toggleLevelOff(currentRoom);
    }
    function callOtto(time)
    {
      var delay = Phaser.Math.RND.between(7000,20000);
      if(time >= ottoTimer + delay)
      {
        if(firstRoom)
        {
          otto.x = 40;
          otto.y = 300;
        }
        else
          {
            otto.x = entryX;
            otto.y = entryY;
          }
          ottoTimer = 50000000;
        otto.enableBody();
        otto.setVisible(true);
        otto.setActive(true);
      }
    }
    function closeDoor(direction)
    {
      doors.children.iterate(function (exit) {
        if(exit.child == direction)
        {
          exit.setActive(true);
          exit.setVisible(true);
          exit.enableBody(true,true);
        }
        else {
          exit.setActive(false);
          exit.setVisible(false);
          exit.disableBody();
        }
      });
    }
    function resetOtto()
    {
      otto.disableBody();
      otto.setVisible(false);
      otto.setActive(false);
      if(firstRoom)
      {
        ottoTimer = 0;
      }
      else{
      ottoTimer = this.time;
      }
    }
    function createLevelOne()
    {
      levelOneWalls.create(110, 200, 'horizontalwall');
      levelOneWalls.create(250, 400, 'horizontalwall');
      levelOneWalls.create(600, 300, 'verticalwall');
      levelOneWalls.create(510, 210, 'horizontalwall');
    }
    function createLevelTwo()
    {
      levelTwoWalls.create(400, 200, 'horizontalwall');
      levelTwoWalls.create(200, 225, 'horizontalwall');
      levelTwoWalls.create(100, 300, 'verticalwall');
      levelTwoWalls.create(300, 200, 'horizontalwall');
    }
    function createAnimations(anims)
    {
      anims.create({
          key: 'left',
          frames: anims.generateFrameNumbers('dudeleft', { start: 0, end: 6 }),
          frameRate: 10,
          repeat: -1
      });

      anims.create({
          key: 'right',
          frames: anims.generateFrameNumbers('duderight', { start: 0, end: 6 }),
          frameRate: 10,
          repeat: -1
      });

      anims.create({
          key: 'enemyleft',
          frames: anims.generateFrameNumbers('enemyleft', { start: 0, end: 6 }),
          frameRate: 10,
          repeat: -1
      });

      anims.create({
          key: 'enemyright',
          frames: anims.generateFrameNumbers('enemyright', { start: 0, end: 6 }),
          frameRate: 10,
          repeat: -1
      });

      anims.create({
          key: 'idleright',
          frames: [ { key: 'idleright', frame: 0 } ],
          frameRate: 20
      });

      anims.create({
          key: 'idleleft',
          frames: [ { key: 'idleleft', frame: 0 } ],
          frameRate: 20
      });
    }
</script>

</body>
</html>
